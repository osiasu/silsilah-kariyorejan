<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <title>SILSILAH TRAH KARIYOREJAN</title>
  <style>
    :root {
      --primary-color: #ffcc00;
      --accent-color: #e67e22;
      --bg-color: #0f0f0f;
      --border-color: #2c2c2c;
      --text-color: #f5f5f5;
    }

    @media print {
      #pageTitle {
        opacity: 1 !important;
      }
      #controls,
      .toggle-btn,
      .clear-btn {
        display: none !important;
      }
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 2rem;
      background-image: url('https://plus.unsplash.com/premium_photo-1733306529857-34bd61ff63b7?q=80&w=3784&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
      background-size: cover;
      background-repeat: repeat;
      background-attachment: fixed;
      background-color: rgba(15, 15, 15, 0.85);
      backdrop-filter: blur(1px);
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 2rem;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
    }

    #controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      position: sticky;
      top: 0;
      z-index: 1000;
      background-color: rgba(15, 15, 15, 0.9);
      padding: 0.5rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.6);
      border-bottom: 1px solid var(--border-color);
      backdrop-filter: blur(1px);
    }

    input,
    select,
    button {
      padding: 0.5rem;
      font-size: 0.8rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: #1e1e1e;
      color: var(--text-color);
    }

    button {
      background-color: var(--accent-color);
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(230, 126, 34, 0.4);
      transition: all 0.3s ease;
    }

    button:hover {
      background-color: #d35400;
      box-shadow: 0 6px 18px rgba(230, 126, 34, 0.6);
      transform: translateY(-2px);
    }

    mark {
      background-color: #ffdd57;
      padding: 0 3px;
      border-radius: 3px;
    }

    .bold-name {
      font-weight: bold;
    }

    .node-label {
      font-size: 0.95rem;
      transition: color 0.3s ease;
    }

    .node-label:hover {
      color: var(--accent-color);
    }

    .hidden {
      display: none;
    }

    #tree-container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(30, 30, 30, 0.95);
      padding: 1.5rem 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
      border: 1px solid var(--border-color);
    }

    ul {
      list-style: none;
      padding-left: 1rem;
      margin-top: 0.4rem;
    }

    .tree-node {
      margin: 0.5rem 0;
      position: relative;
      padding-left: 1.2rem;
    }

    .tree-node::before {
      content: "";
      position: absolute;
      top: 0.5rem;
      left: 0;
      width: 8px;
      height: 8px;
      background-color: var(--accent-color);
      border-radius: 50%;
    }

    .toggle-btn {
      cursor: pointer;
      margin-right: 6px;
      font-weight: bold;
      color: var(--primary-color);
      font-size: 0.9rem;
    }

    .search-wrapper {
      position: relative;
    }

    .search-wrapper input {
      padding: 0.6rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.7rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: box-shadow 0.2s ease;
    }

    .search-wrapper input:focus {
      outline: none;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
      border-color: var(--accent-color);
    }

    .clear-btn {
      position: absolute;
      top: 50%;
      right: 6px;
      transform: translateY(-50%);
      background: #2c2c2c;
      border: 1px solid #444;
      border-radius: 50%;
      padding: 2px 8px;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      color: #bbb;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      display: none;
    }

    .search-wrapper input:not(:placeholder-shown)~.clear-btn {
      display: inline;
    }

    #pageTitle {
      transition: opacity 0.3s ease;
    }

    #goTopBtn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1001;
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.6);
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      padding: 0;
    }

    #goTopBtn:hover {
      background-color: #d35400;
      transform: scale(1.1);
    }

    #goTopBtn.show {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>

<body>
  <h1 id="pageTitle">‚óÜ‚ùñ SILSILAH TRAH KARIYOREJAN ‚ùñ‚óÜ</h1>
    <div id="controls">
      <button id="toggleAllBtn" onclick="toggleAll()">üìÇ Expand All</button>

      <div class="search-wrapper">
        <input type="text" id="searchBox" placeholder="üîç Cari nama..." oninput="handleSearch()" />
        <span class="clear-btn" onclick="clearSearch()">√ó</span>
      </div>

      <select id="generationFilter" onchange="handleGenerationFilter()">
        <option value="">üî¢ Semua Generasi</option>
        <option value="1">Generasi 1: Anak</option>
        <option value="2">Generasi 2: Cucu</option>
        <option value="3">Generasi 3: Buyut</option>
        <option value="4">Generasi 4: Canggah</option>
        <option value="5">Generasi 5: Wareng</option>
      </select>

      <span id="counterPanel" style="align-self: center; font-size: 0.8rem; font-weight: bold;">
        Menampilkan: Semua anggota
      </span>
      

      <button onclick="location.reload()">üîÑ Refresh</button>
      <button onclick="window.print()">üñ®Ô∏è Cetak / Export PDF</button>
    </div>

    <div id="tree-container">Memuat data...</div>
    <button id="goTopBtn" onclick="scrollToTop()" aria-label="Scroll to top">
      <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" aria-hidden="true">
        <path d="M4.71 15.29a1 1 0 001.42 0L12 9.41l5.88 5.88a1 1 0 001.41-1.41l-6.59-6.59a1 1 0 00-1.41 0l-6.59 6.59a1 1 0 000 1.41z" />
      </svg>
    </button>


    <script>
    const sheetURL = "data.csv";
    // const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvTPek8lPJYcaKNBWHeH-YXTIqQVCzsZPFeOPpbXVyQ4ff_bkn3EWKST1-XGbVJZRNW1I6ygBEih7L/pub?gid=394450677&single=true&output=csv";
    window.__TREE_DATA__ = [];

    async function loadCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      const rows = text.trim().split("\n").map(r => r.split(","));
      const headers = rows[0];
      const data = rows.slice(1).map(row => {
        let obj = {};
        headers.forEach((h, i) => obj[h.trim()] = row[i]?.trim());
        return obj;
      });
      return data;
    }

    function formatNameLabel(nama, pasangan) {
      if (!pasangan || pasangan === "-") {
        return {
          text: nama,
          html: `<span class="bold-name">${nama}</span>`
        };
      }
      return {
        text: `${nama} & ${pasangan}`,
        html: `<span class="bold-name">${nama}</span> & ${pasangan}`
      };
    }

    function buildTree(data, parentId = "") {
      const children = data.filter(d => d["Parent ID"] === parentId);
      if (!children.length) return null;

      const ul = document.createElement("ul");
      children.forEach(child => {
        const li = document.createElement("li");
        li.className = "tree-node";

        const label = document.createElement("span");
        label.className = "node-label";

        let isRoot = !child["Parent ID"];
        const {
          text: originalText,
          html: formattedHTML
        } = formatNameLabel(child.Nama, child.Pasangan);

        label.setAttribute("data-original", originalText);
        label.setAttribute("data-id", child.ID);

        // Make root node fully bold
        label.innerHTML = isRoot ?
          `<strong>${formattedHTML}</strong>` :
          formattedHTML;


        const childNodes = buildTree(data, child.ID);
        if (childNodes) {
          const toggle = document.createElement("span");
          toggle.className = "toggle-btn";
          toggle.textContent = "+";
          toggle.onclick = () => {
            const sub = li.querySelector("ul");
            const hidden = sub.classList.toggle("hidden");
            toggle.textContent = hidden ? "+" : "‚àí";
          };

          li.append(toggle, label, childNodes);
          childNodes.classList.add("hidden");
        } else {
          li.appendChild(label);
        }

        ul.appendChild(li);
      });

      return ul;
    }

    (async () => {
      try {
        const data = await loadCSV(sheetURL);
        window.__TREE_DATA__ = data;
        const tree = buildTree(data);
        const container = document.getElementById("tree-container");
        container.innerHTML = "";
        container.appendChild(tree || document.createTextNode("Data tidak bisa ditampilkan."));
      } catch (err) {
        document.getElementById("tree-container").textContent = "Gagal memuat data.";
        console.error("Gagal:", err);
      }
    })();

    let expanded = false;

    function toggleAll() {
      const allToggles = document.querySelectorAll(".toggle-btn");
      allToggles.forEach(toggle => {
        const sublist = toggle.parentElement.querySelector("ul");
        if (sublist) {
          sublist.classList.toggle("hidden", expanded);
          toggle.textContent = expanded ? "+" : "‚àí";
        }
      });

      expanded = !expanded;
      document.querySelector("#toggleAllBtn").textContent = expanded ? "üìÅ Collapse All" : "üìÇ Expand All";
    }

    function handleSearch() {
      document.getElementById("generationFilter").value = "";

      const keyword = document.getElementById("searchBox").value.trim().toLowerCase();
      const nodes = document.querySelectorAll(".tree-node");

      nodes.forEach(node => {
        node.dataset.match = "false";
        const label = node.querySelector(".node-label");
        const id = label.getAttribute("data-id");
        const nodeData = getDataById(id);
        if (!nodeData) return;

        const isRoot = !nodeData["Parent ID"];
        const {
          html: formattedHTML
        } = formatNameLabel(nodeData.Nama, nodeData.Pasangan);
        label.innerHTML = isRoot ? `<strong>${formattedHTML}</strong>` : formattedHTML;
      });

      if (keyword.length < 2) {
        resetTreeView();
        return;
      }

      const matchedNodes = [];
      nodes.forEach(node => {
        const label = node.querySelector(".node-label");
        const original = label.getAttribute("data-original").toLowerCase();
        if (original.includes(keyword)) {
          node.dataset.match = "true";
          node.style.display = "list-item";
          matchedNodes.push(node);

          const highlighted = label.getAttribute("data-original").replace(new RegExp(`(${keyword})`, "gi"), "<mark>$1</mark>");
          label.innerHTML = highlighted;
        } else {
          node.style.display = "none";
        }
      });

      matchedNodes.forEach(expandParents);
      const counterPanel = document.getElementById("counterPanel");
if (matchedNodes.length > 0) {
  counterPanel.textContent = `Menampilkan: ${matchedNodes.length} hasil pencarian`;
} else {
  counterPanel.textContent = "Tidak ada hasil pencarian.";
}

    }

    function expandParents(node) {
      let parent = node.parentElement.closest(".tree-node");
      while (parent) {
        parent.style.display = "list-item";
        const ul = parent.querySelector("ul");
        if (ul) ul.classList.remove("hidden");
        const toggle = parent.querySelector(".toggle-btn");
        if (toggle) toggle.textContent = "‚àí";
        parent = parent.parentElement.closest(".tree-node");
      }
    }

    function clearSearch() {
      document.getElementById("searchBox").value = "";
      document.getElementById("generationFilter").value = "";
      resetTreeView();
      document.getElementById("counterPanel").textContent = "Menampilkan: Semua anggota";

    }

    

    function resetTreeView() {
      const nodes = document.querySelectorAll(".tree-node");
      nodes.forEach(node => {
        node.style.display = "list-item";
        node.dataset.match = "false";

        const label = node.querySelector(".node-label");
        const id = label.getAttribute("data-id");
        const nodeData = getDataById(id);
        if (!nodeData) return;

        const {
          html: formattedHTML
        } = formatNameLabel(nodeData.Nama, nodeData.Pasangan);
        const isRoot = !nodeData["Parent ID"];
        label.innerHTML = isRoot ? `<strong>${formattedHTML}</strong>` : formattedHTML;


        const ul = node.querySelector("ul");
        const toggle = node.querySelector(".toggle-btn");
        if (ul) {
          ul.classList.add("hidden");
          if (toggle) toggle.textContent = "+";
        }
      });

      expanded = false;
      document.getElementById("toggleAllBtn").textContent = "üìÇ Expand All";
      document.getElementById("counterPanel").textContent = "Menampilkan: Semua anggota";

    }

    function getDataById(id) {
      return window.__TREE_DATA__.find(d => d.ID === id);
    }

    function handleGenerationFilter() {
      document.getElementById("searchBox").value = "";

      const selectedGen = document.getElementById("generationFilter").value;
      const nodes = document.querySelectorAll(".tree-node");

      nodes.forEach(node => {
        node.style.display = "none";
        const label = node.querySelector(".node-label");
        const original = label.getAttribute("data-original");
        label.innerHTML = original;
      });

      if (!selectedGen) {
  document.getElementById("counterPanel").textContent = "Menampilkan: Semua anggota";
  resetTreeView();
  return;
}


      const matchedNodes = [];

      nodes.forEach(node => {
        const label = node.querySelector(".node-label");
        const id = label?.getAttribute("data-id");
        const dataNode = getDataById(id);

        if (!dataNode) return;

        const isRoot =
          dataNode.Nama.toLowerCase().includes("kariyo rejo") &&
          dataNode["Parent ID"] === "";

        if (dataNode.Generasi === selectedGen || isRoot) {
          node.style.display = "list-item";

          // Format the label correctly by checking if "Pasangan" is "-"
          const {
            html: formattedHTML
          } = formatNameLabel(dataNode.Nama, dataNode.Pasangan);
          const isRoot = !dataNode["Parent ID"];
          label.innerHTML = isRoot ? `<strong>${formattedHTML}</strong>` : formattedHTML;


          if (dataNode.Generasi === selectedGen) {
            matchedNodes.push(node);
          }
        }
      });

      matchedNodes.forEach(expandParents);

      const counterPanel = document.getElementById("counterPanel");
if (matchedNodes.length > 0) {
  counterPanel.textContent = `Menampilkan: ${matchedNodes.length} anggota Generasi ${selectedGen}`;
} else {
  counterPanel.textContent = "Tidak ada anggota yang cocok.";
}

    }

    // fade in title
    window.addEventListener("scroll", () => {
      const title = document.getElementById("pageTitle");
      const maxScroll = 100; // how far to scroll before fully faded
      const opacity = Math.max(0, 1 - window.scrollY / maxScroll);
      title.style.opacity = opacity;
    });

    const goTopBtn = document.getElementById("goTopBtn");

    window.addEventListener("scroll", () => {
      if (window.scrollY > 200) {
        goTopBtn.classList.add("show");
      } else {
        goTopBtn.classList.remove("show");
      }
    });

    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: "smooth"
      });
    }
    </script>
  </body>

</html>